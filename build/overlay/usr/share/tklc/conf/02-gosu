#!/bin/bash -ex

BOOTSTRAP_TOOLS="wget gnupg2 dirmngr"
GOSU_VERSION="1.10"
GOSU_URL="https://github.com/tianon/gosu/releases/download/${GOSU_VERSION}/gosu-amd64"

apt-get install ${BOOTSTRAP_TOOLS}

wget -O /usr/local/bin/gosu "${GOSU_URL}"
wget -O /usr/local/bin/gosu.asc "${GOSU_URL}.asc"

export GNUPGHOME="$(mktemp -d)"

# rsa4096/036A9C25BF357DD4 2014-02-28 Tianon Gravi <tianon@tianon.xyz>
GPG_ID='B42F6819007F00F88E364FD4036A9C25BF357DD4'

gpg --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys "${GPG_ID}" \
|| gpg --keyserver hkp://ipv4.pool.sks-keyservers.net --recv-keys "${GPG_ID}" \
|| gpg --keyserver hkp://pgp.mit.edu:80 --recv-keys "${GPG_ID}"

gpg --batch --verify /usr/local/bin/gosu.asc /usr/local/bin/gosu
rm -rf "${GNUPGHOME}" /usr/local/bin/gosu.asc
chmod +x /usr/local/bin/gosu

USER=
if [[ ! -z "${KEEP_USER}"  ]]; then
    USER="${KEEP_USER}"
else
    USER="${APP_NAME}"
fi

gosu "${USER}" true
apt-get purge ${BOOTSTRAP_TOOLS}
